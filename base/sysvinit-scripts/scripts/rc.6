#!/bin/sh
#
# /etc/rc.d/rc. : ce fichier est exécuté lors du redémarrage (niveau 6) ou
# de l'extinction (niveau 0) de la machine. Tous les processus sont tués,
# les systèmes de fichiers démontés.
# Très lourdement inspiré de Slackware.

# On spécifie le $PATH.
PATH=/sbin:/etc:/bin:/usr/bin

# Si des csripts SysV sont présents pour ce niveau, on les exécute :
if [ -x /etc/rc.d/rc.sysvinit ]; then
	. /etc/rc.d/rc.sysvinit
fi

# On évite l'effet d'escalier de la console :
/bin/stty onlcr

echo "Exécution du script d'arrêt $0 :"

case "$0" in
	*0)
		command="halt"
		;;
	*6)
		command=reboot
		;;
	*)
		echo "$0 : Appelez-moi \"rc.0\" ou \"rc.6\", je vous prie !"
		exit 1
		;;
esac

# On sauvegarde l'heure du système dans l'horloge matérielle :
if [ -x /sbin/hwclock ]; then
	if grep -q "^UTC" /etc/hardwareclock 2> /dev/null ; then
		/sbin/hwclock --utc --systohc
	else
		/sbin/hwclock --localtime --systohc
	fi
fi

# On exécute les scripts d'arrêt locaux s'ils existent :
if [ -x /etc/rc.d/rc.local_shutdown ]; then
	/etc/rc.d/rc.local_shutdown stop
fi

# On arrête NFS :
if [ -x /etc/rc.d/rc.nfsd ]; then
	/etc/rc.d/rc.nfsd stop
fi

# On arrête SSH :
if [ -x /etc/rc.d/rc.sshd ]; then
	/etc/rc.d/rc.sshd stop
fi

# On arrête D-Bus :
if [ -x /etc/rc.d/rc.messagebus ]; then
	/etc/rc.d/rc.messagebus stop
fi

# On désactive le réseau :
if [ -x /etc/rc.d/rc.inet1 ]; then
	. /etc/rc.d/rc.inet1 stop
fi

# On tue tous les processus :
/sbin/killall5 -15 
/bin/sleep 2
/sbin/killall5 -9

# On enregistre notre graine de génération de nombres aléatoires en utilisant
# le fichier « poolsize » du noyau :
dd if=/dev/urandom of=/etc/random-seed count=1 bs=$(cat /proc/sys/kernel/random/poolsize) 2> /dev/null
chmod 600 /etc/random-seed

# On enregistre l'action ('halt' ou 'reboot') dans 'wtmp' :
$command -w

# On nettoie /var/lock/subsys :
if [ -d /var/lock/subsys ]; then
	rm -f /var/lock/subsys/*
fi

# On désactive la partition d'échange (« swap ») :
/sbin/swapoff -a

# On synchronise le tout :
/bin/sync

# On démonte ce qui reste :
umount -v -a -t no,proc,sysfs

# On éteind ou redémarre la machine :
if [ "$command" = "reboot" ]; then
	echo "Redémarrage."
	/sbin/reboot
else
	echo "Au revoir !"
	/sbin/poweroff
fi

# C'est fini !
