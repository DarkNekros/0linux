#!/bin/bash -e

source /usr/lib64/grub/grub-mkconfig_lib

set_fallback_theme()
{
  cat << EOF
set menu_color_normal=green/black
set menu_color_highlight=light-green/black
EOF
}

# check for usable backgrounds
use_bg=false
if [ "$GRUB_TERMINAL_OUTPUT" = "gfxterm" ] ; then
  for i in {/boot/grub,/usr/share/wallpapers}/0-grub-background.{png,tga,jpg,jpeg} ; do
    if is_path_readable_by_grub $i ; then 
      bg=$i
      case ${bg} in
        *.png)			reader=png ;;
        *.tga)			reader=tga ;;
        *.jpg|*.jpeg)	reader=jpeg ;;
      esac
      if test -e /boot/grub/${reader}.mod ; then
        echo "Found background: `basename ${bg}`" >&2
        use_bg=true
        break
      fi
    fi
  done
fi

# set the background if possible
if ${use_bg} ; then
  prepare_grub_to_access_device `${grub_probe} --target=device ${bg}`
  cat << EOF
insmod ${reader}
if background_image `make_system_path_relative_to_its_root ${bg}` ; then
  set menu_color_normal=green/black
  set menu_color_highlight=light-green/black
else
EOF
fi

# otherwise, set a default theme
if ${use_bg} ; then
  set_fallback_theme | sed -e "s/^/  /g"
  echo "fi"
else
  set_fallback_theme
fi
